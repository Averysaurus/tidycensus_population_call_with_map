---
title: "Population Demographic for San Francisco, 2019 acs"
output: html_document
date: '2022-06-16'
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}

# install `pacman` if necessary.
if (!require("pacman")) install.packages("pacman")

# load, install packages via `pacman`
pacman::p_load(
  tidycensus,    # census api
  tidyverse,     # data wrangling
  janitor,
  sf,            # spatial stuff   
  leaflet,
  mapview
  )


```

You need a `Census API key` to access Census Bureau API

 <https://api.census.gov/data/key_signup.html>

-   Key will be sent to your email fairly quickly

Info for all public facing Census API: <https://www.census.gov/data/developers/data-sets.html>*

Code below is commented out because Census key has been stored locally.

```{r}


# census_api_key("YOuR CENSUS API KEY HERE",
#              install = TRUE) 
#  store locally
# census_api_key(key = my_census_api_key)


```

Load variables available from Census Bureau API 

- Info explaining each value in the `dataset` argument. 
<https://api.census.gov/data.html> 

```{r}


acs_2019_vars <- load_variables(2019,  # year 
               dataset = 'acs1',       # specify `acs1` data
               cache = T) %>%          # save call locally 
                                       # tab out results as window
                View()


```


There is lots of variables here! Below we subset relevant ones. 

```{r}

# relevant variable names. 
acs2019_slice <- load_variables(2019, 
                    dataset = 'acs1', 
                    cache = T) %>%
                    slice(1:328) #subset top 328 rows 

```

* Create Object with those `328` variables, spaced in a friendly way to add
to a `get_acs()` call to the API. 

```{r}

acs_vars <- 
  # add white-space on both sides. 
  str_pad(acs2019_slice$name, 1,
                   side = 'both', 
                   pad = ' ') 


head(acs_vars)

```

With a little clever text-editing (hold *Ctrl* key to select tabular-ly and 
dragging around) we can create a concatenated list of all variables.

```{r}

# All "population" variables by sex and race? 2019 ACS 


all_those_vars = c(
  "B01001_001" ,"B01001_002" ,"B01001_003" ,
  "B01001_004" ,"B01001_005" ,"B01001_006" ,
  "B01001_007" ,"B01001_008"  ,"B01001_009" ,
  "B01001_010" ,"B01001_011" ,"B01001_012" ,
  "B01001_013" ,"B01001_014" ,"B01001_015" ,
  "B01001_016" ,"B01001_017" ,"B01001_018" ,
  "B01001_019" ,"B01001_020" ,"B01001_021" ,
  "B01001_022" ,"B01001_023" ,"B01001_024" ,
  "B01001_025" ,"B01001_026" ,"B01001_027" ,
  "B01001_028" ,"B01001_029" ,"B01001_030" ,
  "B01001_031" ,"B01001_032" ,"B01001_033" ,
  "B01001_034" ,"B01001_035" ,"B01001_036" ,
  "B01001_037" ,"B01001_038" ,"B01001_039" ,
  "B01001_040" ,"B01001_041" ,"B01001_042" ,
  "B01001_043" ,"B01001_044" ,"B01001_045" ,
  "B01001_046" ,"B01001_047" ,"B01001_048" ,
  "B01001_049" ,"B01001A_001","B01001A_002",
  "B01001A_003","B01001A_004","B01001A_005",
  "B01001A_006","B01001A_007","B01001A_008",
  "B01001A_009","B01001A_010","B01001A_011",
  "B01001A_012","B01001A_013","B01001A_014",
  "B01001A_015","B01001A_016","B01001A_017",
  "B01001A_018","B01001A_019","B01001A_020",
  "B01001A_021","B01001A_022","B01001A_023",
  "B01001A_024","B01001A_025","B01001A_026",
  "B01001A_027","B01001A_028","B01001A_029",
  "B01001A_030","B01001A_031","B01001B_001",
  "B01001B_002","B01001B_003","B01001B_004",
  "B01001B_005","B01001B_006","B01001B_007",
  "B01001B_008","B01001B_009","B01001B_010",
  "B01001B_011","B01001B_012","B01001B_013",
  "B01001B_014","B01001B_015","B01001B_016",
  "B01001B_017","B01001B_018","B01001B_019",
  "B01001B_020","B01001B_021","B01001B_022",
  "B01001B_023","B01001B_024","B01001B_025",
  "B01001B_026","B01001B_027","B01001B_028",
  "B01001B_029","B01001B_030","B01001B_031",
  # Just keep scrolling.. 
  "B01001C_001","B01001C_002","B01001C_003",
  "B01001C_004","B01001C_005","B01001C_006",
  "B01001C_007","B01001C_008","B01001C_009",
  "B01001C_010","B01001C_011","B01001C_012",
  "B01001C_013","B01001C_014","B01001C_015",
  "B01001C_016","B01001C_017","B01001C_018",
  "B01001C_019","B01001C_020","B01001C_021",
  "B01001C_022","B01001C_023","B01001C_024",
  "B01001C_025","B01001C_026","B01001C_027",
  "B01001C_028","B01001C_029","B01001C_030",
  "B01001C_031","B01001D_001","B01001D_002",
  "B01001D_003","B01001D_004","B01001D_005",
  "B01001D_006","B01001D_007","B01001D_008",
  "B01001D_009","B01001D_010","B01001D_011",
  "B01001D_012","B01001D_013","B01001D_014",
  "B01001D_015","B01001D_016","B01001D_017",
  "B01001D_018","B01001D_019","B01001D_020",
  "B01001D_021","B01001D_022","B01001D_023",
  "B01001D_024","B01001D_025","B01001D_026",
  "B01001D_027","B01001D_028","B01001D_029",
  "B01001D_030","B01001D_031","B01001E_001",
  "B01001E_002","B01001E_003","B01001E_004",
  "B01001E_005","B01001E_006","B01001E_007",
  "B01001E_008","B01001E_009","B01001E_010",
  "B01001E_011","B01001E_012","B01001E_013",
  "B01001E_014","B01001E_015","B01001E_016",
  "B01001E_017","B01001E_018","B01001E_019",
  "B01001E_020","B01001E_021","B01001E_022",
  "B01001E_023","B01001E_024","B01001E_025",
  "B01001E_026","B01001E_027","B01001E_028",
  "B01001E_029","B01001E_030","B01001E_031",
  "B01001F_001","B01001F_002","B01001F_003",
  "B01001F_004","B01001F_005","B01001F_006",
  "B01001F_007","B01001F_008","B01001F_009",
  "B01001F_010","B01001F_011","B01001F_012",
  "B01001F_013","B01001F_014","B01001F_015",
  "B01001F_016","B01001F_017","B01001F_018",
  "B01001F_019","B01001F_020","B01001F_021",
  "B01001F_022","B01001F_023","B01001F_024",
  "B01001F_025","B01001F_026","B01001F_027",
  "B01001F_028","B01001F_029","B01001F_030",
  "B01001F_031","B01001G_001","B01001G_002",
  "B01001G_003","B01001G_004","B01001G_005",
  "B01001G_006","B01001G_007","B01001G_008",
  "B01001G_009","B01001G_010","B01001G_011",
  "B01001G_012","B01001G_013","B01001G_014",
  "B01001G_015","B01001G_016","B01001G_017",
  "B01001G_018","B01001G_019","B01001G_020",
  "B01001G_021","B01001G_022","B01001G_023",
  "B01001G_024","B01001G_025","B01001G_026",
  "B01001G_027","B01001G_028","B01001G_029",
  "B01001G_030","B01001G_031","B01001H_001",
  "B01001H_002","B01001H_003","B01001H_004",
  "B01001H_005","B01001H_006","B01001H_007",
  "B01001H_008","B01001H_009","B01001H_010",
  "B01001H_011","B01001H_012","B01001H_013",
  "B01001H_014","B01001H_015","B01001H_016",
  "B01001H_017","B01001H_018","B01001H_019",
  # Almost there! 
  "B01001H_020","B01001H_021","B01001H_022",
  "B01001H_023","B01001H_024","B01001H_025",
  "B01001H_026","B01001H_027","B01001H_028",
  "B01001H_029","B01001H_030","B01001H_031",
  "B01001I_001","B01001I_002","B01001I_003",
  "B01001I_004","B01001I_005","B01001I_006",
  "B01001I_007","B01001I_008","B01001I_009",
  "B01001I_010","B01001I_011","B01001I_012",
  "B01001I_013","B01001I_014","B01001I_015",
  "B01001I_016","B01001I_017","B01001I_018",
  "B01001I_019","B01001I_020","B01001I_021",
  "B01001I_022","B01001I_023","B01001I_024",
  "B01001I_025","B01001I_026","B01001I_027",
  "B01001I_028","B01001I_029","B01001I_030",
  "B01001I_031")


```


 Next we call the Census Bureau API, asking to download `all_those_vars`. 
 `geometry` includes spatial data associated to each census tract, added for sanity testing the API calls. 

```{r}


sfpop2019_acs <- get_acs(
  geography = 'tract',          # tract level data
  variables = all_those_vars,   # 328 variables from above list. 
  state = 'CA',
  county = 'San Francisco', 
  geometry = T                  # add geometry
)

head(sfpop2019_acs)

```

* Join with variables loaded, clean up excess string detritus. 

```{r}


sfpop2019_fin <- left_join(sfpop2019_acs,         
                         acs2019_slice, 
                         by = c('variable' = 'name')) %>% 
  select(-variable) %>%          # remove "variable" variable
  janitor::clean_names() %>%     # lower column names for legibility 
  filter(estimate != 0) %>%      # filter where population estimate is not 0 
          # manipulate strings in label column for legibility. 
 
   mutate(label = str_remove_all(label, 'Estimate!!'), 
         label = str_replace_all(label, '!!', ' '), 
         label = str_replace_all(label, ':', ''),
         # extract census tract code from verbose column, and rename column.
         name = str_extract_all(name, '(\\d+.\\d+)')) %>% 
  rename(census_tract = name)
  


```


* Sanity Check: mapping subset variables.


```{r}

     # filter where total male 25-29
sf_male_pop_ex <- sfpop2019_fin %>% 
  filter(concept == "SEX BY AGE" &
           str_detect(label, "Total Male 25 to 29 years")) %>% 
     # restructure estimate from character to numeric structure.
  mutate(estimate = as.numeric(estimate))

```


```{r}

# plot as map
plot(sf_male_pop_ex['estimate'])
```



```{r}

# use leaftet wrapper. 
mapview(sf_male_pop_ex, zcol="estimate")

```



```{r}


```